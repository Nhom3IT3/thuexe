<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Thuê Xe</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .wrapper {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 200px; /* Thu nhỏ sidebar */
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

            .sidebar .nav-link {
                cursor: pointer;
                padding: 10px 15px; /* Điều chỉnh padding */
            }

        .content {
            flex-grow: 1;
            padding: 20px;
        }

            .content > div {
                display: none;
            }

                .content > div.active {
                    display: block;
                }

        .sidebar .nav-link.active {
            font-weight: bold;
        }

        .sidebar h4 {
            font-size: 1.2em; /* Điều chỉnh kích thước tiêu đề */
        }

        .hidden-column {
            display: none;
        }

        /* CSS cho thông báo */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            display: none;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="sidebar">
            <h4>Quản lý</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#customerManagement">Quản lý Khách Hàng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#carManagement">Quản lý Xe</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#rentalManagement">Quản lý Thuê Xe</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#paymentManagement">Quản lý Thanh Toán</a>
                </li>
            </ul>
        </div>
        <div class="content">
            <div id="home" class="active">
                <h2>Chào mừng bạn đến với hệ thống quản lý thuê xe</h2>
                <p>Chọn một chức năng từ menu để bắt đầu.</p>
            </div>
            <div id="customerManagement">
                <h2>Quản lý Khách Hàng</h2>
                <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addCustomerModal">Thêm khách hàng</button>
                <input type="text" id="txttim" placeholder="Tìm kiếm..." class="form-control mb-3" />
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên</th>
                            <th>Địa chỉ</th>
                            <th>Điện thoại</th>
                            <th>CCCD</th>
                            <th>Tên Đăng Nhập</th>
                            <th>Mật Khẩu</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Các khách hàng sẽ được thêm vào đây -->
                    </tbody>
                </table>
            </div>

            <!-- Modal thêm/sửa khách hàng -->
            <div class="modal fade" id="addCustomerModal" tabindex="-1" role="dialog" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addCustomerModalLabel">Thêm khách hàng</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="customerForm">
                                <div class="form-group">
                                    <label for="customerId">Mã</label>
                                    <input type="text" class="form-control" id="customerId" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="customerName">Tên</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                                <div class="form-group">
                                    <label for="customerAddress">Địa chỉ</label>
                                    <input type="text" class="form-control" id="customerAddress" required>
                                </div>
                                <div class="form-group">
                                    <label for="customerPhone">Điện thoại</label>
                                    <input type="text" class="form-control" id="customerPhone" required>
                                </div>
                                <div class="form-group">
                                    <label for="customerCccd">CCCD</label>
                                    <input type="text" class="form-control" id="customerCccd">
                                </div>
                                <div class="form-group">
                                    <label for="customerTendangnhap">Tên đăng nhập</label>
                                    <input type="text" class="form-control" id="customerTendangnhap">
                                </div>
                                <div class="form-group">
                                    <label for="customerMatkhau">Mật khẩu</label>
                                    <input type="password" class="form-control" id="customerMatkhau">
                                </div>
                                <button type="submit" class="btn btn-primary">Lưu</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="carManagement">
                <h2>Quản lý Xe</h2>
                <!-- Nội dung quản lý xe -->
            </div>
            <div id="rentalManagement">
                <h2>Quản lý Thuê Xe</h2>
                <!-- Nội dung quản lý thuê xe -->
            </div>
            <div id="paymentManagement">
                <h2>Quản lý Thanh Toán</h2>
                <!-- Nội dung quản lý thanh toán -->
            </div>
        </div>
    </div>

    <!-- Thông báo -->
    <div id="notification" class="alert alert-dismissible fade show" role="alert">
        <strong id="notificationMessage"></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.nav-link').click(function (event) {
                event.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');

                var target = $(this).attr('href').substring(1);
                $('.content > div').removeClass('active');
                $('#' + target).addClass('active');
            });

            $('#home').addClass('active');

            let customers = [];

            function LayDulieu() {
                var url = "https://localhost:7019/api/KhachHang/list";
                fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => response.json())
                    .then(data => {
                        customers = data.data || [];
                        renderCustomers();
                    })
                    .catch((error) => { console.error('Error:', error); });
            }
            LayDulieu();

            function renderCustomers() {
                const tbody = $('#customerTableBody');
                tbody.empty();
                customers.forEach((customer, index) => {
                    const row = `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${customer.khHoTen}</td>
                                            <td>${customer.khDiaChi}</td>
                                            <td>${customer.khSoDt}</td>
                                            <td>${customer.khCccd}</td>
                                            <td>${customer.khTendangnhap}</td>
                                            <td>${customer.khMatkhau}</td>
                                            <td>
                                                <button class="btn btn-warning btn-sm edit-btn" data-index="${index}">Sửa</button>
                                                <button class="btn btn-danger btn-sm delete-btn" data-index="${index}">Xóa</button>
                                            </td>
                                        </tr>
                                    `;
                    tbody.append(row);
                });
            }

            function showNotification(message, type) {
                $('#notificationMessage').text(message);
                $('#notification').removeClass('alert-success alert-danger');
                $('#notification').addClass(type);
                $('#notification').fadeIn().delay(3000).fadeOut();
            }

            $('#txttim').on('input', function () {
                var searchTerm = $(this).val().trim();
                if (searchTerm === "") {
                    LayDulieu(); // Nếu không có từ khóa, hiển thị lại tất cả khách hàng
                    return;
                }

                var url = "https://localhost:7019/api/KhachHang/search";
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ SearchTerm: searchTerm })
                }).then(response => response.json())
                    .then(data => {
                        if (data && data.data) {
                            customers = data.data;
                            renderCustomers();
                        } else {
                            console.error('No data returned or data field is missing');
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            });

            $('#customerForm').submit(function (event) {
                event.preventDefault();
                const khId = $('#customerId').val().trim();
                const khHoTen = $('#customerName').val().trim();
                const khDiaChi = $('#customerAddress').val().trim();
                const khSoDt = $('#customerPhone').val().trim();
                const khCccd = $('#customerCccd').val().trim();
                const khTendangnhap = $('#customerTendangnhap').val().trim();
                const khMatkhau = $('#customerMatkhau').val().trim();
                const nguoiSua = "admin";

                const customer = { khId, khHoTen, khDiaChi, khSoDt, khCccd, khTendangnhap, khMatkhau, nguoiSua };
                const index = $('#customerForm').data('editIndex');

                if (index >= 0) {
                    fetch(`https://localhost:7019/api/KhachHang/update?khId=${encodeURIComponent(khId)}&ten=${encodeURIComponent(khHoTen)}&tel=${encodeURIComponent(khSoDt)}&dc=${encodeURIComponent(khDiaChi)}&cccd=${encodeURIComponent(khCccd)}&login=${encodeURIComponent(khTendangnhap)}&mk=${encodeURIComponent(khMatkhau)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(customer)
                    }).then(response => response.json())
                        .then(data => {
                            customers[index] = data.data;
                            $('#customerForm').removeData('editIndex');
                            renderCustomers();
                            showNotification("Cập nhật khách hàng thành công.", "alert-success");
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            showNotification("Có lỗi xảy ra khi cập nhật khách hàng.", "alert-danger");
                        });
                } else {
                    fetch(`https://localhost:7019/api/KhachHang/insert?ten=${encodeURIComponent(khHoTen)}&tel=${encodeURIComponent(khSoDt)}&dc=${encodeURIComponent(khDiaChi)}&cccd=${encodeURIComponent(khCccd)}&login=${encodeURIComponent(khTendangnhap)}&mk=${encodeURIComponent(khMatkhau)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(response => response.json())
                        .then(data => {
                            customers.push(data.data);
                            renderCustomers();
                            showNotification("Thêm khách hàng thành công.", "alert-success");
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            showNotification("Có lỗi xảy ra khi thêm khách hàng.", "alert-danger");
                        });
                }

                $('#addCustomerModal').modal('hide');
                this.reset();
            });

            $(document).on('click', '.delete-btn', function () {
                if (!confirm('Bạn có chắc chắn muốn xóa không?')) return;

                const index = $(this).data('index');
                const id = customers[index].khId;
                fetch(`https://localhost:7019/api/KhachHang/delete?id=${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => response.json())
                    .then(data => {
                        customers.splice(index, 1);
                        renderCustomers();
                        showNotification("Xóa khách hàng thành công.", "alert-success");
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        showNotification("Có lỗi xảy ra khi xóa khách hàng.", "alert-danger");
                    });
            });

            $(document).on('click', '.edit-btn', function () {
                const index = $(this).data('index');
                const customer = customers[index];
                $('#customerId').val(customer.khId);
                $('#customerName').val(customer.khHoTen);
                $('#customerAddress').val(customer.khDiaChi);
                $('#customerPhone').val(customer.khSoDt);
                $('#customerCccd').val(customer.khCccd);
                $('#customerTendangnhap').val(customer.khTendangnhap);
                $('#customerMatkhau').val(customer.khMatkhau);
                $('#customerForm').data('editIndex', index);
                $('#addCustomerModalLabel').text('Sửa khách hàng');
                $('#addCustomerModal').modal('show');
            });

            $('#addCustomerModal').on('hidden.bs.modal', function () {
                $('#customerForm')[0].reset();
                $('#addCustomerModalLabel').text('Thêm khách hàng');
                $('#customerForm').removeData('editIndex');
            });
        });
    </script>
</body>
</html>
